<div class="pointerLine"></div>
            <div class="track" id="track_d"></div>
          </div>
        </div>

        <div class="result" id="resultBox_d">
          <div style="font-weight:900; margin-bottom:10px;">ğŸ‰ ä½ æŠ½åˆ°ï¼š</div>
          <div class="resultTop">
            <div class="resultThumb" id="resultThumb_d">ğŸ«§</div>
            <div class="resultMeta">
              <strong id="resultText_d"></strong>
              <div class="small" id="resultHint_d"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbwK_VSXqE9oczBRqh07hvDGl9sEzJKbBvPz6KGt7Lvpzy_7ms7599rWxd1zPFYeJzOb/exec';
  const TYPES = ["é›¨å‚˜å¨ƒ","ä¸‰éº—é·—è¯å","é¾è¦æ‰£","ä¸€ä»£è»Ÿç³–","å·§å…‹åŠ›","é¤…ä¹¾","è»Šè»Š","æ¨¡å‹åŒ…"];
  const LOVELYS = ["Navely","Jeongvely","Movely","Savely","Jively","Mively","Davely","Chaengvely","Tzuvely"];
  const FILLERS = ["âœ¨","ğŸ’™","ğŸ²","ğŸ«§","â­","ğŸ"];

  async function callGas(body){
    const resp = await fetch(GAS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body || {})
    });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    return resp.json();
  }

  async function draw(code){
    return callGas({ code });
  }

  // ===== å®‰å…¨ storageï¼ˆiOS ç„¡ç—•ä¸æœƒç‚¸ï¼‰=====
  const MODE_KEY = 'gocha_mode';
  let memoryMode = 'auto';
  function safeGetMode(){
    try { return localStorage.getItem(MODE_KEY) || 'auto'; }
    catch(e){ return memoryMode || 'auto'; }
  }
  function safeSetMode(v){
    memoryMode = v;
    try { localStorage.setItem(MODE_KEY, v); } catch(e){}
  }

  function applyMode(mode){
    document.body.classList.remove('is-mobile','is-desktop');

    if (mode === 'mobile') document.body.classList.add('is-mobile');
    else if (mode === 'desktop') document.body.classList.add('is-desktop');
    else {
      const w = Math.min(window.innerWidth || 9999, document.documentElement.clientWidth || 9999);
      document.body.classList.add(w <= 768 ? 'is-mobile' : 'is-desktop');
    }
  }

  function initMode(){
    applyMode(safeGetMode());
    window.addEventListener('resize', () => {
      if (safeGetMode() === 'auto') applyMode('auto');
    }, { passive:true });
    window.addEventListener('orientationchange', () => {
      if (safeGetMode() === 'auto') applyMode('auto');
    }, { passive:true });
  }

  function toggleMode(){
    const isMobileNow = document.body.classList.contains('is-mobile');
    const next = isMobileNow ? 'desktop' : 'mobile';
    safeSetMode(next);
    applyMode(next);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  initMode();

  // ===== Catalog / ç¬¬äºŒæ®µé–å®š type =====
  let catalog = { typeImages:{}, typeLovelyImages:{} };
  let currentTypeForLovely = '';

  google.script.run
    .withSuccessHandler((resp)=>{ if(resp && resp.ok) catalog = resp; })
    .getPrizeCatalog();
  (async ()=>{
    try {
      const resp = await callGas({ action:'catalog' });
      if (resp && resp.ok) catalog = resp;
    } catch(e){
      console.warn('Failed to load catalog', e);
    }
  })();

  const el = (id)=>document.getElementById(id);
  const pickRandom = (arr)=> (!arr || arr.length===0) ? '' : arr[Math.floor(Math.random()*arr.length)];
  const shuffle = (arr)=>{
    const a = arr.slice();
    for (let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  };
  const rotateToIndex = (arr, target, desiredIndex)=>{
    const idx = arr.indexOf(target);
    if (idx===-1) return arr;
    const shift = (idx - desiredIndex + arr.length) % arr.length;
    return arr.slice(shift).concat(arr.slice(0, shift));
  };

  function getRandomTypeImage(type){ return pickRandom(catalog.typeImages?.[type] || []); }
  function getRandomLovelyImageForType(type, lovely){
    return pickRandom(catalog.typeLovelyImages?.[type]?.[lovely] || []);
  }

  function buildUniqueSequence(items, target){
    const fillerCount = 18, tailFillerCount = 10, desiredPosInCore = items.length - 2;
@@ -610,60 +629,59 @@

    await anim.finished;
    t.style.transform = `translateY(${finalY}px)`;
    setMsg(suffix, '');
  }

  function setResult(suffix, resp){
    el('resultText_'+suffix).textContent = `${resp.type} / ${resp.color}`;
    el('resultHint_'+suffix).textContent = `çé …ä»£è™Ÿï¼š${resp.prize_key}`;

    const box = el('resultThumb_'+suffix);
    box.innerHTML = '';
    if (resp.image_url){
      const img = document.createElement('img');
      img.src = resp.image_url;
      img.loading = 'eager';
      img.onerror = () => { box.textContent = 'ğŸ«§'; };
      box.appendChild(img);
    } else {
      box.textContent = 'ğŸ«§';
    }

    el('resultBox_'+suffix).style.display = 'block';
  }

  function start(suffix){
  async function start(suffix){
    const code = (el('code_'+suffix).value || '').trim().toUpperCase();

    el('resultBox_'+suffix).style.display = 'none';
    setMsg(suffix, '');
    setBusy(suffix, true);

    google.script.run
      .withSuccessHandler(async (resp)=>{
        if (!resp || !resp.ok){
          setMsg(suffix, (resp && resp.message) ? resp.message : 'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤');
          setStage(suffix, 'å¤±æ•—');
          setBusy(suffix, false);
          return;
        }

        currentTypeForLovely = resp.type;
    try {
      const resp = await draw(code);

        await spinVertical(TYPES, resp.type, 'ç¬¬ä¸€æ®µï¼šæŠ½ã€Œç¨®é¡ã€', 'type', suffix);
        await spinVertical(LOVELYS, resp.color, 'ç¬¬äºŒæ®µï¼šæŠ½ã€ŒLOVELYSã€', 'lovely', suffix);

        setStage(suffix, 'é–‹ç®±å®Œæˆ');
        setResult(suffix, resp);
        setBusy(suffix, false);
      })
      .withFailureHandler((err)=>{
        setMsg(suffix, 'é€£ç·šå¤±æ•—ï¼š' + (err && err.message ? err.message : err));
      if (!resp || !resp.ok){
        setMsg(suffix, (resp && resp.message) ? resp.message : 'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤');
        setStage(suffix, 'å¤±æ•—');
        setBusy(suffix, false);
      })
      .drawWithCode(code);
        return;
      }

      currentTypeForLovely = resp.type;

      await spinVertical(TYPES, resp.type, 'ç¬¬ä¸€æ®µï¼šæŠ½ã€Œç¨®é¡ã€', 'type', suffix);
      await spinVertical(LOVELYS, resp.color, 'ç¬¬äºŒæ®µï¼šæŠ½ã€ŒLOVELYSã€', 'lovely', suffix);

      setStage(suffix, 'é–‹ç®±å®Œæˆ');
      setResult(suffix, resp);
      setBusy(suffix, false);
    } catch(err){
      setMsg(suffix, 'é€£ç·šå¤±æ•—ï¼š' + (err && err.message ? err.message : err));
      setStage(suffix, 'å¤±æ•—');
      setBusy(suffix, false);
    }
  }
</script>
</body>
</html>
