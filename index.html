<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <meta name="color-scheme" content="dark" />
  <title>TWICEğŸ’™ONCE I  GOCHA  ç·šä¸Šæ‡‰æ´è½‰è›‹</title>
  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1024;
      --card:#121A33;
      --card2:#0E1630;
      --line:rgba(255,255,255,.12);
      --txt:rgba(240,246,255,.92);
      --muted:rgba(240,246,255,.65);
      --muted2:rgba(240,246,255,.45);
      --accent:#7EA8FF;
      --shadow: 0 12px 40px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
      background: radial-gradient(1200px 700px at 30% -10%, rgba(126,168,255,.20), transparent 60%),
                  radial-gradient(900px 600px at 100% 0%, rgba(160,120,255,.16), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--txt);
      overflow-x:hidden; /* ç¦æ­¢å·¦å³æ‹–æ‹‰ */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      touch-action: pan-y; /* å…è¨±ä¸Šä¸‹æ»‘ */
    }

    .topbar{
      position: sticky; top:0;
      z-index: 20;
      padding: 12px 12px;
      backdrop-filter: blur(10px);
      background: rgba(7,10,18,.55);
      border-bottom: 1px solid var(--line);
    }
    .topbarInner{
      max-width: 860px;
      margin: 0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand h1{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
      line-height: 1.15;
      font-weight: 900;
    }
    .brand .sub{
      margin-top:4px;
      font-size: 12px;
      color: var(--muted);
    }
    .modeBtn{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 800;
      font-size: 13px;
      cursor:pointer;
    }
    .modeBtn:active{ transform: translateY(1px); }

    .wrap{
      max-width: 860px;
      margin: 0 auto;
      padding: 14px 12px 28px;
      width:100%;
    }

    .panel{
      background: rgba(255,255,255,.04);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .inputRow{
      display:flex;
      flex-direction: column;
      gap:10px;
    }

    .codeInput{
      width:100%;
      padding: 14px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: var(--txt);
      font-size: 16px;
      outline: none;
    }
    .codeInput::placeholder{ color: rgba(240,246,255,.40); }

    .btn{
      width:100%;
      padding: 14px 14px;
      border-radius: 16px;
      border: none;
      background: linear-gradient(135deg, rgba(126,168,255,.95), rgba(160,120,255,.92));
      color: #0B1024;
      font-size: 16px;
      font-weight: 1000;
      cursor:pointer;
      box-shadow: 0 10px 30px rgba(126,168,255,.22);
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .statusLine{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-top: 10px;
    }
    .stageLabel{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
    }
    .hint{
      font-size: 12px;
      color: var(--muted);
      padding-top: 6px;
      text-align:right;
      min-height: 18px;
    }

    /* ç›´ç«‹æ‹‰éœ¸æ§½ */
    .slotWrap{ margin-top: 12px; }
    .slotCase{
      position: relative;
      overflow:hidden;
      border-radius: 18px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.22);
      height: 560px;
    }
    .fadeTop,.fadeBot{
      position:absolute; left:0; right:0;
      height: 90px;
      pointer-events:none;
      z-index: 3;
    }
    .fadeTop{
      top:0;
      background: linear-gradient(180deg, rgba(7,10,18,.95), rgba(7,10,18,0));
    }
    .fadeBot{
      bottom:0;
      background: linear-gradient(0deg, rgba(7,10,18,.95), rgba(7,10,18,0));
    }
    .pointerLine{
      position:absolute;
      left:0; right:0;
      top:50%;
      height:2px;
      background: rgba(126,168,255,.65);
      box-shadow: 0 0 18px rgba(126,168,255,.45);
      z-index:4;
      transform: translateY(-1px);
      pointer-events:none;
    }
    .track{
      position:absolute;
      left:0; right:0;
      top:0;
      transform: translateY(0px);
      will-change: transform;
      padding: 18px 14px;
      display:flex;
      flex-direction: column;
      gap: 18px;
    }
    .card{
      display:flex;
      gap: 12px;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
    }
    .thumb{
      width: 44%;
      min-width: 44%;
      height: 230px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      font-size: 28px;
    }
    .thumb img{
      width: 100%;
      height: 100%;
      object-fit: contain; /* ä¸è£åˆ‡ */
      background: rgba(0,0,0,.15);
      display:block;
    }
    .meta{
      flex:1;
      display:flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 10px;
      min-width: 0;
    }
    .title{
      font-size: 18px;
      font-weight: 1000;
      line-height: 1.15;
      word-break: break-word;
    }
    .tag{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted2);
      letter-spacing: .4px;
    }

    .result{
      display:none;
      margin-top: 12px;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
    }
    .resultTop{
      display:flex;
      gap: 12px;
      align-items:center;
      margin-top: 8px;
    }
    .resultThumb{
      width: 120px; height: 120px;
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      display:flex; align-items:center; justify-content:center;
      font-size: 26px;
      flex: 0 0 auto;
    }
    .resultThumb img{ width:100%; height:100%; object-fit: contain; background: rgba(0,0,0,.15); display:block; }
    .resultMeta strong{ font-size: 16px; }
    .resultMeta .small{ margin-top:6px; font-size: 12px; color: rgba(234,240,255,.62); }

    /* æ¨¡å¼ï¼šç”¨ body class æ§åˆ¶ï¼ˆé¿å… app script bar å½±éŸ¿ï¼‰ */
    .desktopOnly{ display:none; }
    .mobileOnly{ display:none; }
    body.is-desktop .desktopOnly{ display:block; }
    body.is-mobile .mobileOnly{ display:block; }

    /* Desktop ç‰ˆç¨å¾®æ›´å¤§ */
    body.is-desktop .wrap{ padding: 18px 14px 30px; }
    body.is-desktop .panel{ padding: 16px; }
    body.is-desktop .slotCase{ height: 660px; }
    body.is-desktop .thumb{ height: 320px; }
    body.is-desktop .title{ font-size: 20px; }

    /* å°æ‰‹æ©Ÿé«˜åº¦èª¿æ•´ */
    @media (max-width: 380px){
      body.is-mobile .slotCase{ height: 520px; }
      body.is-mobile .thumb{ height: 210px; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbarInner">
      <div class="brand">
        <h1>TWICEğŸ’™ONCE I  GOCHA</h1>
        <div class="sub">ç·šä¸Šæ‡‰æ´è½‰è›‹ï½œé»å³ä¸Šè§’å¯åˆ‡æ›æ¡Œæ©Ÿ/æ‰‹æ©Ÿç‰ˆ</div>
      </div>
      <button class="modeBtn" onclick="toggleMode()">ğŸ” æ¡Œæ©Ÿ/æ‰‹æ©Ÿåˆ‡æ›</button>
    </div>
  </div>

  <!-- Mobile -->
  <div class="mobileOnly">
    <div class="wrap">
      <div class="panel">
        <div class="inputRow">
          <input id="code_m" class="codeInput" placeholder="è¼¸å…¥åºè™Ÿï¼ˆæ¸¬è©¦ï¼š20151020ï¼‰" />
          <button id="btn_m" class="btn" onclick="start('m')">è½‰è›‹ ONCE I GOCHA</button>
        </div>

        <div class="statusLine">
          <div><span class="stageLabel" id="stage_m">æº–å‚™ä¸­</span></div>
          <div class="hint" id="msg_m"></div>
        </div>

        <div class="slotWrap">
          <div class="slotCase">
            <div class="fadeTop"></div>
            <div class="fadeBot"></div>
            <div class="pointerLine"></div>
            <div class="track" id="track_m"></div>
          </div>
        </div>

        <div class="result" id="resultBox_m">
          <div style="font-weight:900;">ğŸ‰ ä½ æŠ½åˆ°ï¼š</div>
          <div class="resultTop">
            <div class="resultThumb" id="resultThumb_m">ğŸ«§</div>
            <div class="resultMeta">
              <strong id="resultText_m"></strong>
              <div class="small" id="resultHint_m"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Desktop -->
  <div class="desktopOnly">
    <div class="wrap">
      <div class="panel">
        <div class="inputRow" style="max-width:560px;margin:0 auto;">
          <input id="code_d" class="codeInput" placeholder="è¼¸å…¥åºè™Ÿï¼ˆæ¸¬è©¦ï¼š20151020ï¼‰" />
          <button id="btn_d" class="btn" onclick="start('d')">è½‰è›‹ ONCE I GOCHA</button>
        </div>

        <div class="statusLine" style="max-width:560px;margin:10px auto 0;">
          <div><span class="stageLabel" id="stage_d">æº–å‚™ä¸­</span></div>
          <div class="hint" id="msg_d"></div>
        </div>

        <div class="slotWrap" style="max-width:640px;margin:12px auto 0;">
          <div class="slotCase">
            <div class="fadeTop"></div>
            <div class="fadeBot"></div>
            <div class="pointerLine"></div>
            <div class="track" id="track_d"></div>
          </div>
        </div>

        <div class="result" id="resultBox_d" style="max-width:640px;margin:12px auto 0;">
          <div style="font-weight:900;">ğŸ‰ ä½ æŠ½åˆ°ï¼š</div>
          <div class="resultTop">
            <div class="resultThumb" id="resultThumb_d">ğŸ«§</div>
            <div class="resultMeta">
              <strong id="resultText_d"></strong>
              <div class="small" id="resultHint_d"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // === ä½ çš„ GAS Web App URLï¼ˆä¸è¦æ”¹å‹•æ ¼å¼ï¼‰===
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbwK_VSXqE9oczBRqh07hvDGl9sEzJKbBvPz6KGt7Lvpzy_7ms7599rWxd1zPFYeJzOb/exec';

  const TYPES = ["é›¨å‚˜å¨ƒ","ä¸‰éº—é·—è¯å","é¾è¦æ‰£","ä¸€ä»£è»Ÿç³–","å·§å…‹åŠ›","é¤…ä¹¾","è»Šè»Š","æ¨¡å‹åŒ…"];
  const LOVELYS = ["Navely","Jeongvely","Movely","Savely","Jively","Mively","Davely","Chaengvely","Tzuvely"];
  const FILLERS = ["âœ¨","ğŸ’™","ğŸ²","ğŸ«§","â­","ğŸ"];

  // ===== JSONPï¼šé¿å… GitHub Pages CORSï¼ˆFailed to fetchï¼‰=====
  function jsonpCall(params){
    return new Promise((resolve, reject) => {
      const cb = 'cb_' + Math.random().toString(36).slice(2);
      const url = new URL(GAS_URL);
      Object.entries(params || {}).forEach(([k,v]) => url.searchParams.set(k, String(v)));
      url.searchParams.set('callback', cb);

      const s = document.createElement('script');
      let done = false;

      const timer = setTimeout(() => {
        if (done) return;
        done = true;
        cleanup();
        reject(new Error('timeout'));
      }, 15000);

      function cleanup(){
        clearTimeout(timer);
        try { delete window[cb]; } catch(e) { window[cb] = undefined; }
        s.remove();
      }

      window[cb] = (data) => {
        if (done) return;
        done = true;
        cleanup();
        resolve(data);
      };

      s.onerror = () => {
        if (done) return;
        done = true;
        cleanup();
        reject(new Error('script load error'));
      };

      s.src = url.toString();
      document.head.appendChild(s);
    });
  }

  async function loadCatalog(){
    try{
      const resp = await jsonpCall({ action:'catalog' });
      if (resp && resp.ok) catalog = resp;
    }catch(e){
      console.warn('catalog failed', e);
      // ä¸æ“‹æŠ½çï¼šåªæœƒè®“è½‰å‹•æ™‚é¡¯ç¤º ğŸ«§
    }
  }

  async function draw(code){
    return await jsonpCall({ action:'draw', code });
  }

  // ===== å®‰å…¨ storageï¼ˆiOS ç„¡ç—•ä¸æœƒç‚¸ï¼‰=====
  const MODE_KEY = 'gocha_mode';
  let memoryMode = 'auto';
  function safeGetMode(){
    try { return localStorage.getItem(MODE_KEY) || 'auto'; }
    catch(e){ return memoryMode || 'auto'; }
  }
  function safeSetMode(v){
    memoryMode = v;
    try { localStorage.setItem(MODE_KEY, v); } catch(e){}
  }

  function applyMode(mode){
    document.body.classList.remove('is-mobile','is-desktop');
    if (mode === 'mobile') document.body.classList.add('is-mobile');
    else if (mode === 'desktop') document.body.classList.add('is-desktop');
    else {
      const w = Math.min(window.innerWidth || 9999, document.documentElement.clientWidth || 9999);
      document.body.classList.add(w <= 768 ? 'is-mobile' : 'is-desktop');
    }
  }

  function initMode(){
    applyMode(safeGetMode());
    window.addEventListener('resize', () => {
      if (safeGetMode() === 'auto') applyMode('auto');
    }, { passive:true });
    window.addEventListener('orientationchange', () => {
      if (safeGetMode() === 'auto') applyMode('auto');
    }, { passive:true });
  }

  function toggleMode(){
    const isMobileNow = document.body.classList.contains('is-mobile');
    const next = isMobileNow ? 'desktop' : 'mobile';
    safeSetMode(next);
    applyMode(next);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // ===== Catalog / ç¬¬äºŒæ®µé–å®š type =====
  let catalog = { typeImages:{}, typeLovelyImages:{} };
  let currentTypeForLovely = '';

  const el = (id)=>document.getElementById(id);
  const pickRandom = (arr)=> (!arr || arr.length===0) ? '' : arr[Math.floor(Math.random()*arr.length)];
  const shuffle = (arr)=>{
    const a = arr.slice();
    for (let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  };
  const rotateToIndex = (arr, target, desiredIndex)=>{
    const idx = arr.indexOf(target);
    if (idx===-1) return arr;
    const shift = (idx - desiredIndex + arr.length) % arr.length;
    return arr.slice(shift).concat(arr.slice(0, shift));
  };

  function getRandomTypeImage(type){ return pickRandom(catalog.typeImages?.[type] || []); }

  // ç¬¬äºŒæ®µï¼šé‡å°ã€Œç¬¬ä¸€æ®µæŠ½åˆ°çš„ç¨®é¡ã€+ã€Œç›®å‰é€™å€‹ lovelyã€å–åœ–
  // ç‚ºäº†é¿å…æ•´æ¢éƒ½åŒä¸€å¼µï¼šæ¯æ¬¡è½‰å‹•å‰å…ˆå»ºä¸€è¼ª cacheï¼Œæ¯å€‹ LOVELY å›ºå®š 1 å¼µ
  let lovelyImgCache = {};
  function buildLovelyCacheForType(type){
    lovelyImgCache = {};
    for (const l of LOVELYS){
      const pool = catalog.typeLovelyImages?.[type]?.[l] || [];
      lovelyImgCache[l] = pickRandom(pool);
    }
  }
  function getLovelyCachedImage(type, lovely){
    return (lovelyImgCache && lovelyImgCache[lovely]) ? lovelyImgCache[lovely] : '';
  }

  function buildUniqueSequence(items, target){
    const fillerCount = 18, tailFillerCount = 10, desiredPosInCore = items.length - 2;
    let core = shuffle(items);
    core = rotateToIndex(core, target, desiredPosInCore);
    const head = Array.from({length:fillerCount}, ()=>pickRandom(FILLERS));
    const tail = Array.from({length:tailFillerCount}, ()=>pickRandom(FILLERS));
    const seq = head.concat(core, tail);
    const stopIndex = head.length + desiredPosInCore;
    return { seq, stopIndex };
  }

  function setBusy(suffix, b){
    el('btn_'+suffix).disabled = b;
    el('code_'+suffix).disabled = b;
  }
  function setStage(suffix, t){ el('stage_'+suffix).textContent = t || ''; }
  function setMsg(suffix, t){ el('msg_'+suffix).textContent = t || ''; }

  function renderCardsVertical(seq, mode, suffix){
    const t = el('track_'+suffix);
    t.innerHTML = '';

    for (const text of seq){
      const card = document.createElement('div');
      card.className = 'card';

      const thumb = document.createElement('div');
      thumb.className = 'thumb';

      const meta = document.createElement('div');
      meta.className = 'meta';

      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = text;

      const tag = document.createElement('div');
      tag.className = 'tag';

      const isFiller = FILLERS.includes(text);

      if (isFiller){
        thumb.textContent = text;
        tag.textContent = 'GOCHA';
      } else {
        let src = '';
        if (mode === 'type'){
          src = getRandomTypeImage(text);
          tag.textContent = 'TYPE';
        } else {
          src = getLovelyCachedImage(currentTypeForLovely, text);
          tag.textContent = 'LOVELYS';
        }

        if (src){
          const img = document.createElement('img');
          img.src = src;
          img.loading = 'eager';
          img.onerror = () => { thumb.textContent = 'ğŸ«§'; };
          thumb.appendChild(img);
        } else {
          thumb.textContent = 'ğŸ«§';
        }
      }

      meta.appendChild(title);
      meta.appendChild(tag);
      card.appendChild(thumb);
      card.appendChild(meta);
      t.appendChild(card);
    }
  }

  async function spinVertical(items, target, labelText, mode, suffix){
    setStage(suffix, labelText);
    setMsg(suffix, 'è½‰è›‹ä¸­â€¦');

    if (mode === 'lovely'){
      buildLovelyCacheForType(currentTypeForLovely);
    }

    const { seq, stopIndex } = buildUniqueSequence(items, target);
    renderCardsVertical(seq, mode, suffix);

    const t = el('track_'+suffix);
    const firstCard = t.querySelector('.card');
    if (!firstCard){
      setMsg(suffix, 'ç„¡æ³•æ¸²æŸ“å¡ç‰‡');
      return;
    }

    const rect = firstCard.getBoundingClientRect();
    const step = rect.height + 18;
    const box = t.parentElement.getBoundingClientRect();
    const centerY = box.height / 2;
    const targetCenter = (stopIndex * step) + (step / 2);
    const finalY = centerY - targetCenter;

    t.style.transform = 'translateY(0px)';

    const anim = t.animate(
      [{ transform:'translateY(0px)' }, { transform:`translateY(${finalY}px)` }],
      { duration: 12000, easing:'cubic-bezier(0.08, 0.82, 0.16, 1)', fill:'forwards' }
    );

    await anim.finished;
    t.style.transform = `translateY(${finalY}px)`;
    setMsg(suffix, '');
  }

  function setResult(suffix, resp){
    el('resultText_'+suffix).textContent = `${resp.type} / ${resp.color}`;
    el('resultHint_'+suffix).textContent = resp.prize_key ? `çé …ä»£è™Ÿï¼š${resp.prize_key}` : '';

    const box = el('resultThumb_'+suffix);
    box.innerHTML = '';
    if (resp.image_url){
      const img = document.createElement('img');
      img.src = resp.image_url;
      img.loading = 'eager';
      img.onerror = () => { box.textContent = 'ğŸ«§'; };
      box.appendChild(img);
    } else {
      box.textContent = 'ğŸ«§';
    }

    el('resultBox_'+suffix).style.display = 'block';
  }

  async function start(suffix){
    const code = (el('code_'+suffix).value || '').trim().toUpperCase();

    el('resultBox_'+suffix).style.display = 'none';
    setMsg(suffix, '');
    setBusy(suffix, true);

    try{
      const resp = await draw(code);

      if (!resp || !resp.ok){
        setMsg(suffix, resp?.message || 'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤');
        setStage(suffix, 'å¤±æ•—');
        setBusy(suffix, false);
        return;
      }

      currentTypeForLovely = resp.type;

      await spinVertical(TYPES, resp.type, 'ç¬¬ä¸€æ®µï¼šæŠ½ã€Œç¨®é¡ã€', 'type', suffix);
      await spinVertical(LOVELYS, resp.color, 'ç¬¬äºŒæ®µï¼šæŠ½ã€ŒLOVELYSã€', 'lovely', suffix);

      setStage(suffix, 'é–‹ç®±å®Œæˆ');
      setResult(suffix, resp);
      setBusy(suffix, false);

    }catch(err){
      setMsg(suffix, 'é€£ç·šå¤±æ•—ï¼š' + (err?.message || err));
      setStage(suffix, 'å¤±æ•—');
      setBusy(suffix, false);
    }
  }

  // init
  initMode();
  loadCatalog();
</script>
</body>
</html>
